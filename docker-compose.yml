version: '3'

services:

  redis:
      image: "bitnami/redis:latest"
      environment:
        # ALLOW_EMPTY_PASSWORD is recommended only for development.
        - ALLOW_EMPTY_PASSWORD=yes
        - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
      labels:
        kompose.service.type: nodeport
      ports:
        - "6379:6379"
      volumes:
        - "redis_data:/bitnami/redis"

  elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:6.4.1
      container_name: elasticsearch-container
      environment:
        - cluster.name=elasticsearch-cluster
        - bootstrap.memory_lock=true
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      ulimits:
        memlock:
          soft: -1
          hard: -1
      ports:
        - 9200:9200
        - 9300:9300
      volumes:
        - esdata:/usr/share/elasticsearch/data

  zookeeper:
      image: wurstmeister/zookeeper
      ports:
        - "2181:2181"

  kafka:
      image: "wurstmeister/kafka"
      ports:
        - "9092"
      environment:
        KAFKA_ADVERTISED_HOST_NAME: kafka
        KAFKA_ADVERTISED_PORT: 9092
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        KAFKA_CREATE_TOPICS: "notificationCommandTopic:1:1,notificationEventTopic:1:1,taskCommandTopic:1:1,taskEventTopic:1:1,collaborationEventTopic:1:1"
        KAFKA_DELETE_TOPIC_ENABLE: "true"
        KAFKA_BROKER_ID: 100
      volumes:
        - "kafka_data:/var/run/docker.sock"
      depends_on:
        - zookeeper

  collaboration-transformer-app:
      build:
        context: .
        dockerfile: collaboration-transformer-app/app.dockerfile
      ports:
        - "8081:8080"
      volumes:
        - "collaboration-transformer-app_logs:/opt/applications/logs"
      depends_on:
        - kafka
        - redis

  collaboration-ui-app:
      build:
        context: .
        dockerfile: collaboration-ui-app/app.dockerfile
      ports:
        - "8083:8080"
      volumes:
        - "collaboration-ui-app_logs:/opt/applications/logs"
      depends_on:
        - collaboration-service-app

  notification-command-consumer-app:
      build:
        context: .
        dockerfile: notification-command-consumer-app/app.dockerfile
      ports:
        - "8084:8080"
      volumes:
        - "notification-command-consumer-app_logs:/opt/applications/logs"
      depends_on:
        - kafka

  notification-indexer-app:
      build:
        context: .
        dockerfile: notification-indexer-app/app.dockerfile
      ports:
        - "8085:8080"
      volumes:
        - "notification-indexer-app_logs:/opt/applications/logs"
      depends_on:
        - elasticsearch
        - kafka

  notification-service-app:
      build:
        context: .
        dockerfile: notification-service-app/app.dockerfile
      ports:
        - "8086:8080"
      volumes:
        - "notification-service-app_logs:/opt/applications/logs"
      depends_on:
        - elasticsearch

  notification-ui-app:
      build:
        context: .
        dockerfile: notification-ui-app/app.dockerfile
      ports:
        - "8087:8080"
      volumes:
        - "notification-ui-app_logs:/opt/applications/logs"
      depends_on:
        - notification-service-app

  task-command-consumer-app:
      build:
        context: .
        dockerfile: task-command-consumer-app/app.dockerfile
      ports:
        - "8088:8080"
      volumes:
        - "task-command-consumer-app_logs:/opt/applications/logs"
      depends_on:
        - kafka

  task-indexer-app:
      build:
        context: .
        dockerfile: task-indexer-app/app.dockerfile
      ports:
        - "8089:8080"
      volumes:
        - "task-indexer-app_logs:/opt/applications/logs"
      depends_on:
        - elasticsearch
        - kafka

  task-service-app:
      build:
        context: .
        dockerfile: task-service-app/app.dockerfile
      ports:
        - "8090:8080"
      volumes:
        - "task-service-app_logs:/opt/applications/logs"
      depends_on:
        - elasticsearch

  task-ui-app:
      build:
        context: .
        dockerfile: task-ui-app/app.dockerfile
      ports:
        - "8091:8080"
      volumes:
        - "task-ui-app_logs:/opt/applications/logs"
      depends_on:
        - task-service-app

  collaboration-service-app:
      build:
        context: .
        dockerfile: collaboration-service-app/app.dockerfile
      ports:
        - "8092:8080"
      volumes:
        - "collaboration-service-app_logs:/opt/applications/logs"
      depends_on:
        - kafka

volumes:
    redis_data:
      driver: local
    esdata:
      driver: local
    kafka_data:
      driver: local
    collaboration-ui-app_logs:
      driver: local
    collaboration-transformer-app_logs:
      driver: local
    collaboration-service-app_logs:
      driver: local
    task-ui-app_logs:
      driver: local
    task-command-consumer-app_logs:
      driver: local
    task-indexer-app_logs:
      driver: local
    task-service-app_logs:
      driver: local
    notification-ui-app_logs:
      driver: local
    notification-command-consumer-app_logs:
      driver: local
    notification-indexer-app_logs:
      driver: local
    notification-service-app_logs:
      driver: local